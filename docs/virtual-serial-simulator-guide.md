# 虚拟串口模拟器 使用指南

## 简介

虚拟串口模拟器是一个跨平台的串口测试工具，支持：
- 创建虚拟串口对
- Modbus RTU Master/Slave 模式
- 原始串口数据收发
- **周期性自动发送数据**（用于调试）

## 安装依赖

```bash
pip install pyserial
```

可选（用于彩色输出）：
```bash
pip install colorama
```

## 快速开始

### 1. 运行程序

```bash
python virtual_serial_simulator.py
```

### 2. 主菜单

```
═══════════════ 主菜单 ════════════════
 1. 创建虚拟串口对
 2. 连接现有串口
 3. 查看可用串口
 4. 关于/帮助
 0. 退出
═══════════════════════════════════════
```

### 3. 选择模式

创建虚拟串口后，选择工作模式：
1. **Modbus RTU Slave** - 作为从设备响应请求
2. **Modbus RTU Master** - 作为主设备主动轮询
3. **原始串口** - 直接收发二进制数据

## 周期性自动发送

这是用于调试的便捷功能，可以周期性自动发送数据。

### 启动自动发送

运行时输入 `a` 进入自动发送配置：

```
> a

═══════════════ Auto Send ═══════════════
 Status: OFF
═══════════════════════════════════════

Options:
 1. Start auto send
 2. Stop auto send
 3. Set interval (seconds)
 4. Set data (HEX)
 5. Quick presets
```

### 快速预设

选择选项 5 使用预设数据：

| 预设 | 数据 | 说明 |
|------|------|------|
| 1 | `01 03 00 00 00 01` | Modbus 读保持寄存器 |
| 2 | `01 04 00 00 00 01` | Modbus 读输入寄存器 |
| 3 | `01 01 00 00 00 08` | Modbus 读线圈 |
| 4 | `AA BB CC DD` | 自定义测试模式 |

### 使用示例

```bash
# 1. 启动自动发送，选择预设1 (Modbus读请求)
> a
> 5
> 1

# 2. 设置发送间隔为0.5秒
> a
> 3
> 0.5

# 3. 启动自动发送
> a
> 1

# 现在程序会每0.5秒自动发送一次 Modbus 读请求
```

## 其他命令

| 命令 | 功能 |
|------|------|
| `m` | 切换工作模式 |
| `s` | 手动发送 HEX 数据 |
| `a` | 自动发送配置 |
| `c` | 配置参数 |
| `l` | 查看统计信息 |
| `q` | 退出程序 |

## 配置参数

输入 `c` 进入配置：

```
Configuration:
 1. Display HEX/ASCII
 2. Display timestamp
 3. Modbus slave address
 4. Data pattern (for Slave mode)
```

### 数据模式（Slave 模式下）

- **Fixed value** - 固定值不变
- **Random** - 完全随机值
- **Sine wave** - 正弦波变化
- **Random walk** - 随机游走（平滑变化）

## 平台差异

### Windows
- 默认使用 TCP 转发模式（端口 20000/20001）
- 建议安装 [com0com](https://sourceforge.net/projects/com0com/) 创建真实虚拟串口对

### macOS/Linux
- 自动使用 PTY 创建伪终端对
- 无需额外驱动

## 典型应用场景

### 1. 测试 Modbus 从设备

```bash
# 启动程序，选择 Modbus Slave 模式
# 使用自动发送功能周期性发送读请求
# 观察从设备响应
```

### 2. 模拟传感器数据

```bash
# Slave 模式
# 配置数据模式为 Sine wave
# 自动发送 Modbus 读请求
# 观察数据变化
```

### 3. 串口协议调试

```bash
# 原始串口模式
# 设置自动发送自定义协议数据
# 调整间隔观察响应
```

## 常见问题

**Q: Windows 下如何创建虚拟串口对？**
A: 安装 com0com，创建一对串口（如 COM1<->COM2），然后选择"连接现有串口"连接到其中一个。

**Q: 如何修改发送数据？**
A: 使用 `a` 命令进入自动发送配置，选择选项 4 输入自定义 HEX 数据。

**Q: 支持哪些 Modbus 功能码？**
A: Slave 模式支持 01/02/03/04/05/06/0F/10 功能码。

**Q: 数据显示格式可以改吗？**
A: 使用 `c` 命令可以切换 HEX/ASCII 显示和时间戳开关。
